<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Notely | Workspace</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Outfit', 'sans-serif'] },
                    colors: {
                        glass: "rgba(255, 255, 255, 0.05)",
                        glassBorder: "rgba(255, 255, 255, 0.1)",
                        accent: "#6366f1", 
                        accentHover: "#4f46e5",
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #0f172a;
            background-image: 
                radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            color: #e2e8f0;
            min-height: 100vh;
            overflow-x: hidden;
        }
        .glass-panel {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }
        .glass-input {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            transition: all 0.3s ease;
        }
        .glass-input:focus {
            background: rgba(255, 255, 255, 0.08);
            border-color: #6366f1;
            outline: none;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }
        .note-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .note-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
            border-color: rgba(99, 102, 241, 0.4);
        }
        .spinner {
            border: 3px solid rgba(255,255,255,0.1);
            border-left-color: #6366f1;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .page { display: none; opacity: 0; transition: opacity 0.3s ease; }
        .page.active { display: flex; opacity: 1; }
    </style>
</head>
<body class="antialiased selection:bg-indigo-500 selection:text-white">

    <div id="toast" class="fixed top-6 left-1/2 transform -translate-x-1/2 glass-panel px-6 py-3 rounded-full flex items-center gap-3 z-50 transition-all duration-300 -translate-y-32">
        <i class="fa-solid fa-circle-info text-accent"></i>
        <span id="toast-msg" class="font-medium text-sm">Notification</span>
    </div>

    <div id="auth-page" class="page active min-h-screen w-full items-center justify-center p-4 relative">
        <div class="absolute top-20 left-20 w-72 h-72 bg-purple-600 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-blob"></div>
        <div class="absolute bottom-20 right-20 w-72 h-72 bg-indigo-600 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-blob"></div>

        <div class="w-full max-w-md glass-panel p-8 rounded-2xl relative z-10 animate__animated animate__fadeInUp">
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-12 h-12 rounded-xl bg-accent mb-4 shadow-lg shadow-indigo-500/30">
                    <i class="fa-solid fa-bolt text-white text-xl"></i>
                </div>
                <h1 class="text-3xl font-bold tracking-tight text-white mb-2">Notely</h1>
                <p class="text-slate-400">Your second brain, powered by AI.</p>
            </div>

            <div class="flex p-1 bg-slate-800/50 rounded-xl mb-6 border border-white/5">
                <button onclick="toggleAuthMode('login')" id="btn-login-mode" class="flex-1 py-2 rounded-lg text-sm font-medium transition-all bg-slate-700 text-white shadow">Sign In</button>
                <button onclick="toggleAuthMode('register')" id="btn-register-mode" class="flex-1 py-2 rounded-lg text-sm font-medium transition-all text-slate-400 hover:text-white">Register</button>
            </div>

            <form id="login-form" onsubmit="handleLogin(event)" class="space-y-4">
                <div>
                    <label class="text-xs font-semibold text-slate-400 uppercase tracking-wider ml-1">Email</label>
                    <input type="email" id="login-email" class="w-full glass-input rounded-xl px-4 py-3 mt-1" placeholder="you@example.com" required>
                </div>
                <div>
                    <label class="text-xs font-semibold text-slate-400 uppercase tracking-wider ml-1">Password</label>
                    <input type="password" id="login-password" class="w-full glass-input rounded-xl px-4 py-3 mt-1" placeholder="••••••••" required>
                </div>
                <button type="submit" class="w-full bg-accent hover:bg-accentHover text-white font-bold py-3.5 rounded-xl shadow-lg shadow-indigo-500/25 transition-all transform hover:scale-[1.02] active:scale-[0.98]">
                    Sign In
                </button>
            </form>

            <form id="register-form" onsubmit="handleRegister(event)" class="space-y-4 hidden">
                <div>
                    <label class="text-xs font-semibold text-slate-400 uppercase tracking-wider ml-1">Full Name</label>
                    <input type="text" id="reg-name" class="w-full glass-input rounded-xl px-4 py-3 mt-1" placeholder="John Doe" required>
                </div>
                <div>
                    <label class="text-xs font-semibold text-slate-400 uppercase tracking-wider ml-1">Email</label>
                    <input type="email" id="reg-email" class="w-full glass-input rounded-xl px-4 py-3 mt-1" placeholder="you@example.com" required>
                </div>
                <div>
                    <label class="text-xs font-semibold text-slate-400 uppercase tracking-wider ml-1">Password</label>
                    <input type="password" id="reg-pass" class="w-full glass-input rounded-xl px-4 py-3 mt-1" placeholder="••••••••" required>
                </div>
                <button type="submit" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-emerald-500/25 transition-all transform hover:scale-[1.02] active:scale-[0.98]">
                    Create Account
                </button>
                <div id="registerError" class="text-red-400 text-center text-sm hidden"></div>
            </form>
        </div>
    </div>

    <div id="dashboard-page" class="page w-full h-screen overflow-hidden flex-col md:flex-row">
        
        <aside id="sidebar" class="w-full md:w-72 glass-panel border-r-0 md:border-r border-b md:border-b-0 flex flex-col z-40 transition-all duration-300 absolute md:relative -translate-x-full md:translate-x-0 h-full">
            <div class="p-6 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-indigo-500 to-purple-500 flex items-center justify-center shadow-lg">
                        <i class="fa-solid fa-layer-group text-white text-xs"></i>
                    </div>
                    <span class="font-bold text-xl tracking-tight text-white">Notely</span>
                </div>
                <button onclick="toggleSidebar()" class="md:hidden text-slate-400"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>

            <div class="px-4 mb-6">
                <button onclick="openModal()" class="w-full bg-white/5 hover:bg-white/10 border border-white/5 text-white py-3 px-4 rounded-xl flex items-center justify-center gap-2 transition-all group">
                    <div class="w-6 h-6 rounded-full bg-accent flex items-center justify-center group-hover:scale-110 transition-transform">
                        <i class="fa-solid fa-plus text-[10px]"></i>
                    </div>
                    <span class="font-medium">New Note</span>
                </button>
            </div>

            <nav class="flex-1 px-4 space-y-1 overflow-y-auto">
                <button onclick="filterCategory('all', this)" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl bg-accent/10 text-accent border border-accent/20 transition-all">
                    <i class="fa-solid fa-note-sticky w-5"></i> <span class="font-medium">All Notes</span>
                </button>
                <button onclick="filterCategory('personal', this)" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:text-white hover:bg-white/5 transition-all">
                    <i class="fa-solid fa-user w-5"></i> <span class="font-medium">Personal</span>
                </button>
                <button onclick="filterCategory('work', this)" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:text-white hover:bg-white/5 transition-all">
                    <i class="fa-solid fa-briefcase w-5"></i> <span class="font-medium">Work</span>
                </button>
                <button onclick="filterCategory('ideas', this)" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:text-white hover:bg-white/5 transition-all">
                    <i class="fa-solid fa-lightbulb w-5"></i> <span class="font-medium">Ideas</span>
                </button>
            </nav>

            <div class="p-4 border-t border-white/5">
                <div class="flex items-center gap-3 p-3 rounded-xl bg-white/5 border border-white/5">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-blue-500 to-teal-400 flex items-center justify-center text-white font-bold text-sm shadow-md">
                        <span id="avatar-text">U</span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-white truncate" id="user-name-display">User</p>
                        <p class="text-xs text-slate-400 truncate">Pro Account</p>
                    </div>
                    <button onclick="logout()" class="text-slate-400 hover:text-red-400 transition-colors" title="Logout">
                        <i class="fa-solid fa-right-from-bracket"></i>
                    </button>
                </div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col h-full relative overflow-hidden bg-slate-900/50">
            <header class="md:hidden glass-panel h-16 flex items-center justify-between px-4 shrink-0 z-30">
                <span class="font-bold text-lg">Notely</span>
                <button onclick="toggleSidebar()" class="text-white bg-white/10 p-2 rounded-lg"><i class="fa-solid fa-bars"></i></button>
            </header>

            <div class="p-6 md:p-8 flex flex-col md:flex-row justify-between items-start md:items-center gap-4 animate__animated animate__fadeInDown">
                <div>
                    <h2 class="text-3xl font-bold text-white mb-1">My Notes</h2>
                    <p class="text-slate-400 text-sm">Welcome back to your workspace.</p>
                </div>
                <div class="relative w-full md:w-64">
                    <i class="fa-solid fa-search absolute left-3 top-3.5 text-slate-500 text-sm"></i>
                    <input type="text" oninput="filterNotes(this.value)" placeholder="Search anything..." class="w-full glass-input rounded-xl py-2.5 pl-10 pr-4 text-sm focus:ring-2 focus:ring-accent">
                </div>
            </div>

            <div id="notes-grid" class="flex-1 overflow-y-auto p-6 md:p-8 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 content-start pb-24">
            </div>

            <button onclick="openModal()" class="md:hidden absolute bottom-6 right-6 w-14 h-14 bg-accent text-white rounded-full shadow-lg shadow-indigo-500/40 flex items-center justify-center z-40 active:scale-90 transition-transform">
                <i class="fa-solid fa-plus text-xl"></i>
            </button>
        </main>
    </div>

    <div id="note-modal" class="fixed inset-0 z-[60] hidden">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="w-full max-w-2xl glass-panel rounded-2xl p-6 md:p-8 shadow-2xl transform scale-95 opacity-0 transition-all duration-300 flex flex-col max-h-[90vh]" id="modal-content">
                
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-white">Edit Note</h3>
                    <button onclick="closeModal()" class="w-8 h-8 rounded-full bg-white/5 hover:bg-white/10 flex items-center justify-center transition-colors">
                        <i class="fa-solid fa-xmark text-slate-300"></i>
                    </button>
                </div>

                <input type="text" id="note-title" placeholder="Untitled Note" class="w-full bg-transparent text-3xl font-bold text-white placeholder-slate-600 outline-none mb-4 border-none p-0 focus:ring-0">
                
                <textarea id="note-content" placeholder="Start typing or scan an image..." class="w-full flex-1 bg-slate-800/30 rounded-xl p-4 text-slate-300 placeholder-slate-600 outline-none resize-none border border-transparent focus:border-slate-700 focus:bg-slate-800/50 transition-all mb-4"></textarea>

                <div class="flex flex-col md:flex-row justify-between items-center gap-4 mt-auto">
                    <div class="flex gap-2 w-full md:w-auto">
                        <select id="note-category" class="bg-slate-800/50 border border-slate-700 text-slate-300 text-sm rounded-lg focus:ring-accent focus:border-accent block p-2.5 outline-none">
                            <option value="general">No Category</option>
                            <option value="personal">Personal</option>
                            <option value="work">Work</option>
                            <option value="ideas">Ideas</option>
                        </select>
                        
                        <button onclick="triggerScan()" class="flex items-center gap-2 px-4 py-2 bg-slate-800/50 hover:bg-slate-700 border border-slate-600 rounded-lg text-slate-300 transition-all text-sm font-medium">
                            <i class="fa-solid fa-camera"></i> Scan Text
                        </button>
                    </div>

                    <div class="flex gap-3 w-full md:w-auto">
                        <div id="scan-loading" class="hidden items-center gap-2 text-indigo-400 text-sm font-medium">
                            <div class="spinner w-4 h-4"></div> Scanning...
                        </div>
                        <button onclick="saveNote()" class="flex-1 md:flex-none px-6 py-2.5 bg-accent hover:bg-accentHover text-white rounded-lg font-bold shadow-lg shadow-indigo-500/20 transition-all">
                            Save Note
                        </button>
                    </div>
                </div>
                
                <input type="file" id="scan-input" hidden accept="image/*" onchange="handleScan(event)">
            </div>
        </div>
    </div>

    <script>
        const API_URL = "";
        let state = { token: localStorage.getItem('token'), name: localStorage.getItem('name'), notes: [], editingId: null, category: 'all' };

        function toggleAuthMode(mode) {
            const loginForm = document.getElementById('login-form');
            const regForm = document.getElementById('register-form');
            const btnLogin = document.getElementById('btn-login-mode');
            const btnReg = document.getElementById('btn-register-mode');

            if (mode === 'login') {
                loginForm.classList.remove('hidden');
                regForm.classList.add('hidden');
                btnLogin.className = "flex-1 py-2 rounded-lg text-sm font-medium transition-all bg-slate-700 text-white shadow";
                btnReg.className = "flex-1 py-2 rounded-lg text-sm font-medium transition-all text-slate-400 hover:text-white";
            } else {
                loginForm.classList.add('hidden');
                regForm.classList.remove('hidden');
                btnReg.className = "flex-1 py-2 rounded-lg text-sm font-medium transition-all bg-slate-700 text-white shadow";
                btnLogin.className = "flex-1 py-2 rounded-lg text-sm font-medium transition-all text-slate-400 hover:text-white";
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            if(state.token) {
                showPage('dashboard-page');
                updateWelcomeMessage();
                fetchNotes();
            } else {
                showPage('auth-page');
            }
        });

        function showPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function toast(msg, type = 'info') {
            const t = document.getElementById('toast');
            const txt = document.getElementById('toast-msg');
            txt.textContent = msg;
            t.classList.remove('-translate-y-32');
            setTimeout(() => t.classList.add('-translate-y-32'), 3000);
        }

        function escapeHtml(str) {
            if(!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function updateWelcomeMessage() {
            const nameDisplay = document.getElementById('user-name-display');
            const avatarText = document.getElementById('avatar-text');
            const name = state.name || 'User';
            nameDisplay.textContent = name;
            avatarText.textContent = name.charAt(0).toUpperCase();
        }

        async function api(endpoint, method = 'GET', body = null) {
            const opts = { method, headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${state.token}` } };
            if(body) opts.body = JSON.stringify(body);
            try {
                const res = await fetch(API_URL + endpoint, opts);
                if(res.status === 401) logout();
                if (res.status === 204) return { success: true };
                const text = await res.text();
                if (!res.ok) return null;
                return text ? JSON.parse(text) : { success: true };
            } catch(e) { return null; }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const res = await api('/auth/login', 'POST', { email, password });
            if(res && res.token) {
                state.token = res.token;
                state.name = res.name || 'User';
                localStorage.setItem('token', res.token);
                localStorage.setItem('name', state.name);
                showPage('dashboard-page');
                updateWelcomeMessage();
                fetchNotes();
                toast('Welcome back!');
            } else {
                toast('Invalid credentials');
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const errorEl = document.getElementById('registerError');
            errorEl.classList.add('hidden');
            const name = document.getElementById('reg-name').value;
            const email = document.getElementById('reg-email').value;
            const password = document.getElementById('reg-pass').value;

            try {
                const res = await fetch(API_URL + '/auth/register', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, email, password })
                });
                const data = await res.json().catch(() => null);
                if (res.ok) {
                    toast('Account created! Please log in.');
                    toggleAuthMode('login');
                } else {
                    errorEl.textContent = (data && data.error) ? data.error : 'Registration failed.';
                    errorEl.classList.remove('hidden');
                }
            } catch {
                errorEl.textContent = 'Server unreachable';
                errorEl.classList.remove('hidden');
            }
        }

        function logout() {
            localStorage.clear();
            location.reload();
        }

        async function fetchNotes() {
            const grid = document.getElementById('notes-grid');
            grid.innerHTML = '<div class="col-span-full flex justify-center py-20"><div class="spinner"></div></div>';
            const res = await api('/notes?page=1&pageSize=100');
            if(res) { state.notes = res.data || []; renderNotes(); }
            else { grid.innerHTML = ''; }
        }

        function renderNotes() {
            const grid = document.getElementById('notes-grid');
            grid.innerHTML = '';
            let filtered = state.notes;
            
            if(state.category !== 'all') {
                filtered = filtered.filter(n => (n.content||'').toLowerCase().includes('#'+state.category));
            }

            if(filtered.length === 0) {
                grid.innerHTML = `
                    <div class="col-span-full flex flex-col items-center justify-center py-20 text-slate-500">
                        <i class="fa-regular fa-folder-open text-5xl mb-4 opacity-30"></i>
                        <p>No notes found here.</p>
                        <button onclick="openModal()" class="mt-4 text-accent font-medium hover:underline">Create one?</button>
                    </div>
                `;
                return;
            }

            filtered.forEach((note, i) => {
                const el = document.createElement('div');
                el.className = 'note-card glass-panel p-6 rounded-2xl flex flex-col h-64 relative group cursor-pointer animate__animated animate__fadeInUp';
                el.style.animationDelay = `${i * 0.05}s`;
                
                let tagIcon = '<i class="fa-solid fa-note-sticky text-slate-500"></i>';
                let content = note.content || '';
                if(content.includes('#work')) tagIcon = '<div class="px-2 py-1 rounded bg-blue-500/20 text-blue-400 text-xs font-bold uppercase">Work</div>';
                else if(content.includes('#personal')) tagIcon = '<div class="px-2 py-1 rounded bg-emerald-500/20 text-emerald-400 text-xs font-bold uppercase">Personal</div>';
                else if(content.includes('#idea')) tagIcon = '<div class="px-2 py-1 rounded bg-amber-500/20 text-amber-400 text-xs font-bold uppercase">Idea</div>';

                el.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        ${tagIcon}
                        <span class="text-xs text-slate-500">${new Date(note.updatedAt).toLocaleDateString()}</span>
                    </div>
                    <h3 class="font-bold text-lg text-white mb-2 line-clamp-1 group-hover:text-accent transition-colors">${escapeHtml(note.title)}</h3>
                    <p class="text-slate-400 text-sm line-clamp-4 leading-relaxed">${escapeHtml(content)}</p>
                    
                    <div class="absolute bottom-4 right-4 opacity-0 group-hover:opacity-100 transition-all flex gap-2 translate-y-2 group-hover:translate-y-0">
                        <button onclick="event.stopPropagation(); openModal(state.notes.find(n=>n.id==='${note.id}'))" class="w-8 h-8 rounded-lg bg-slate-800 hover:bg-slate-700 text-white flex items-center justify-center transition-colors shadow-lg">
                            <i class="fa-solid fa-pen text-xs"></i>
                        </button>
                        <button onclick="event.stopPropagation(); deleteNote('${note.id}')" class="w-8 h-8 rounded-lg bg-slate-800 hover:bg-red-500/20 hover:text-red-400 text-white flex items-center justify-center transition-colors shadow-lg">
                            <i class="fa-solid fa-trash text-xs"></i>
                        </button>
                    </div>
                `;
                el.onclick = () => openModal(note);
                grid.appendChild(el);
            });
        }

        function filterCategory(cat, btn) {
            state.category = cat;
            document.querySelectorAll('.nav-item').forEach(b => {
                b.classList.remove('bg-accent/10', 'text-accent', 'border-accent/20');
                b.classList.add('text-slate-400', 'hover:bg-white/5');
            });
            btn.classList.remove('text-slate-400', 'hover:bg-white/5');
            btn.classList.add('bg-accent/10', 'text-accent', 'border', 'border-accent/20');
            
            renderNotes();
            if(window.innerWidth < 768) toggleSidebar();
        }

        function filterNotes(query) {
            const lower = query.toLowerCase();
            const cards = document.querySelectorAll('.note-card');
            cards.forEach(c => {
                const text = c.innerText.toLowerCase();
                c.style.display = text.includes(lower) ? 'flex' : 'none';
            });
        }

        function openModal(note = null) {
            state.editingId = note ? note.id : null;
            document.getElementById('note-title').value = note ? note.title : '';
            document.getElementById('note-content').value = note ? note.content : '';
            
            const catSelect = document.getElementById('note-category');
            catSelect.value = 'general';
            if(note) {
                if(note.content.includes('#work')) catSelect.value = 'work';
                if(note.content.includes('#personal')) catSelect.value = 'personal';
                if(note.content.includes('#idea')) catSelect.value = 'ideas';
            }

            const modal = document.getElementById('note-modal');
            const content = document.getElementById('modal-content');
            modal.classList.remove('hidden');
            setTimeout(() => {
                content.classList.remove('scale-95', 'opacity-0');
                content.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function closeModal() {
            const modal = document.getElementById('note-modal');
            const content = document.getElementById('modal-content');
            content.classList.remove('scale-100', 'opacity-100');
            content.classList.add('scale-95', 'opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        async function saveNote() {
            const title = document.getElementById('note-title').value;
            let content = document.getElementById('note-content').value;
            const cat = document.getElementById('note-category').value;
            
            if(!title) { toast('Please add a title'); return; }

            if(cat !== 'general' && !content.includes('#'+cat)) {
                content += `\n\n#${cat}`;
            }

            const method = state.editingId ? 'PUT' : 'POST';
            const url = state.editingId ? `/notes/${state.editingId}` : '/notes';
            
            const res = await api(url, method, { title, content });
            if(res) {
                closeModal();
                fetchNotes();
                toast('Note saved successfully');
            } else {
                toast('Failed to save note');
            }
        }

        async function deleteNote(id) {
            if(!confirm('Are you sure you want to delete this note?')) return;
            const res = await api(`/notes/${id}`, 'DELETE');
            if(res) {
                fetchNotes();
                toast('Note deleted');
            }
        }

        function triggerScan() {
            document.getElementById('scan-input').click();
        }

        async function handleScan(e) {
            const file = e.target.files[0];
            if(!file) return;

            const fd = new FormData();
            fd.append('file', file);
            
            const scanLoader = document.getElementById('scan-loading');
            scanLoader.classList.remove('hidden');
            scanLoader.classList.add('flex');
            
            try {
                const res = await fetch(API_URL + '/notes/upload', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${state.token}` },
                    body: fd
                });
                
                scanLoader.classList.add('hidden');
                scanLoader.classList.remove('flex');

                if(res.ok) {
                    toast('Image scanned successfully!');
                    fetchNotes();
                    closeModal();
                } else {
                    toast('Scan failed. Try a clearer image.');
                }
            } catch(err) {
                scanLoader.classList.add('hidden');
                scanLoader.classList.remove('flex');
                toast('Error uploading image');
            }
            e.target.value = '';
        }

        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            sb.classList.toggle('-translate-x-full');
        }
    </script>
</body>
</html>